window.twotransfair=window.twotransfair||{},twotransfair.server_url="https://cac52aa5.ngrok.io/api",function(t){t.fn.twotransfairModal=function(a=null){var o=this,r=a;return t(this).find(".modal-dismiss, .modal-close").click(function(){o.hideModal(),t(".modal-overlay").hide()}),t(this).find(".modal-back").click(function(){o.hideModal(),1==twotransfair.step?twotransfair.ajax_step_1.showModal():2==twotransfair.step&&twotransfair.ajax_step_2.showModal()}),this.showModal=function(){t(this).css("display","flex")},this.hideModal=function(){t(this).hide()},this.showMsg=function(a){t(this).find(".modal-msg").html(a).show()},this.hideMsg=function(){t(this).find(".modal-msg").hide()},this.showMsgModal=function(t){this.hideModal(),r.find("#twotransfair_failed_msg").html(t),r.showModal()},this.sendAjax=function(a,r){this.hideModal(),this.hideMsg(),t.ajax({method:"post",dataType:"json",crossDomain:!0,url:a.url,data:a.data,success:function(a){if(1==a.code){if(1==twotransfair.step){t("#twotransfair_phone_number").html(a.phone_number),twotransfair.total_value=a.total_value;var s=parseFloat(a.total_value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,");t("#twotransfair_total_value").html(s),t("#twotransfair_policy_url").attr("href",a.url),a.terms.forEach(a=>{t("#twotransfair_terms").append(t("<option></option>").attr("value",a.id).text(a.name))}),twotransfair.step=2}else if(2==twotransfair.step){var i=parseFloat(a.discount_amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,");t("#twotransfair_discount_amount").html(i),twotransfair.discount_amount=a.discount_amount,twotransfair.discount_code=a.discount_code,t("#twotransfair_success_msg").html(a.msg),localStorage.setItem("twotransfair-discount-code",twotransfair.discount_code),localStorage.setItem("twotransfair-checkout-token",twotransfair.checkout_token)}r.showModal()}else o.showMsgModal(a.msg)},error:function(){o.showMsg("Error de servidor interno"),o.showModal()}})},this};var a=function(t){var a=new URL(window.location.href);a.searchParams.append("discount",t),window.location.href=a},o=function(){var o=localStorage.getItem("twotransfair-checkout-token"),r=localStorage.getItem("twotransfair-discount-code"),s=new URL(window.location.href).searchParams.get("discount");if(o!=twotransfair.checkout_token||!r||s){if("shipping_method"==Shopify.Checkout.step){if(s&&s==r)return t("form.edit_checkout .step__footer button[type=submit] span").html("Terminar"),void t("form.edit_checkout").on("submit",function(t){t.preventDefault(),window.location.href="https://"+twotransfair.shop_domain});t("#twotransfair_modals_wrapper").show(),t.ajax({type:"GET",url:"http://"+twotransfair.shop_domain+"/cart.json",dataType:"jsonp",success:function(t){twotransfair.cart_token=t.token}})}}else a(r)};t(document).ready(function(){var r=t("#twotransfair_msg_modal").twotransfairModal(),s=t("#twotransfair_step1_modal").twotransfairModal(r),i=t("#twotransfair_step2_modal").twotransfairModal(r);twotransfair.ajax_step_1=i;var n=t("#twotransfair_step3_modal").twotransfairModal(r);twotransfair.ajax_step_2=n;var e=t("#twotransfair_step4_modal").twotransfairModal(r),d=t("#twotransfair_step5_modal").twotransfairModal(r);s.showModal(),t("#twotransfair_step1_next").click(function(){s.hideModal(),i.showModal()}),t("#twotransfair_step2_next").click(function(){var a=t("#twotransfair_email").val();if(!function(t){return!!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(t).toLowerCase())}(a)||a.length<3)i.showMsg("Email inválido");else{var o=t("#twotransfair_password").val();o.length<1?i.showMsg("Contraseña inválido"):(twotransfair.step=1,i.sendAjax({url:twotransfair.server_url+"/login",data:{email:a,password:o,cart_id:twotransfair.cart_token,shop_domain:twotransfair.shop_domain}},n))}}),t("#twotransfair_step3_next").click(function(){if(t("#twotransfair_agree").prop("checked")){var a=t("#twotransfair_payment_code").val();if(/^\d+$/.test(a)&&6==a.length)n.hideModal(),n.hideMsg(),e.showModal();else n.showMsg("Código inválido")}else n.showMsg("Acepte los términos de crédito para continuar")}),t("#twotransfair_step4_next").click(function(){var a=t("#twotransfair_email").val(),o=t("#twotransfair_payment_code").val(),r=twotransfair.total_value,s=t("#twotransfair_terms").val();e.sendAjax({url:twotransfair.server_url+"/verify",data:{email:a,payment_code:o,reference_code:twotransfair.cart_token,value:r,terms:s,shop_domain:twotransfair.shop_domain}},d)}),t("#twotransfair_step5_finish").click(function(){a(twotransfair.discount_code)}),twotransfair.shop_domain=window.Shopify.Checkout.apiHost,twotransfair.checkout_token=window.Shopify.Checkout.token,o()})}(jQuery);